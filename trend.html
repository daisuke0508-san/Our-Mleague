<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>勝手にMリーグ｜試合ごとのポイント推移</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>

<style>
  :root{--bg:#0f0f12;--panel:#17171b;--ink:#fafafa;--muted:#a8a8b3;--border:#2a2a31}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:-apple-system,"Noto Sans JP","Hiragino Sans",Roboto,Arial}
  header{position:sticky;top:0;z-index:2;background:#121216;border-bottom:1px solid var(--border)}
  .wrap{max-width:1100px;margin:0 auto;padding:10px 12px}
  h1{margin:6px 0 2px 0;font-size:18px}
  .sub{color:var(--muted);font-size:12px}
  .row{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px}
  .btn{padding:8px 12px;border:1px solid var(--border);background:transparent;color:var(--ink);border-radius:8px}
  select{background:#0e0e12;color:var(--ink);border:1px solid var(--border);border-radius:8px;padding:8px}
  .muted{color:var(--muted);font-size:12px}
  #chartBox{position:relative;height:520px}
  .chip{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:6px 10px;margin:4px 6px 0 0}
  .bar{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  a.back{margin-left:auto}
</style>
</head>
<body>

<header>
  <div class="wrap" style="display:flex;align-items:center;gap:10px">
    <div>
      <h1>勝手にMリーグ｜試合ごとのポイント推移</h1>
      <div class="sub">「第1試合→最新試合」をX軸（初期＝全チーム／右端＝最新試合）</div>
    </div>
    <a href="./" class="btn back">ダッシュボードへ</a>
  </div>
</header>

<main class="wrap">
  <div class="panel">
    <div class="row">
      <div>
        <div class="muted">表示モード</div>
        <select id="mode">
          <option value="acc" selected>累計（試合ごとに積み上げ）</option>
          <option value="delta">単試合（その試合の増減）</option>
        </select>
      </div>
      <div class="muted" style="align-self:flex-end">更新: <span id="updated">-</span></div>
      <button id="reload" class="btn" style="margin-left:auto">更新</button>
    </div>

    <div class="bar" id="legendChips"></div>

    <div id="chartBox" class="panel" style="margin-top:10px">
      <canvas id="chart"></canvas>
    </div>
    <div class="muted" style="margin-top:8px">※ 凡例（上）をタップで線の表示ON/OFF</div>
  </div>
</main>

<script>
/* ===== あなたのCSV公開URL ===== */
const TEAM_CSV_URL  =
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vSKiDBUEB6mAd_Jv4YGkDUiZF4PN65NeFnD2lm_sBhbkmWYTk1dvRT0NoAGGxsNTHueHmgQ8iM5up0R/pub?gid=13413896&single=true&output=csv';
const SCORE_CSV_URL =
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vSKiDBUEB6mAd_Jv4YGkDUiZF4PN65NeFnD2lm_sBhbkmWYTk1dvRT0NoAGGxsNTHueHmgQ8iM5up0R/pub?gid=671232666&single=true&output=csv';

/* ===== チーム色（index.html と同一） ===== */
const TEAM_COLORS = {
  "大輔チーム":       "#2a7cff",
  "しげチーム":       "#36b24a",
  "まぎチーム":       "#e0b300",
  "もりチーム":       "#ff8a3d",
  "マサキングチーム": "#ff5db1",
  "ケータチーム":     "#ff0000",
  "最下位チーム":     "#a0a0a8",
  "やや下チーム":     "#7fb3ff",
  "やや上チーム":     "#9b7cff",
  "新人チーム":       "#7fd3ff"
};
/* 未定義チームの保険色 */
const PALETTE = ['#2a7cff','#36b24a','#e0b300','#ff8a3d','#ff5db1','#ff3b30',
                 '#a0a0a8','#9b7cff','#7fd3ff','#9ad67e','#ff8ecf','#ffd166'];
const colorOf = (team,i)=> TEAM_COLORS[team] ?? PALETTE[i % PALETTE.length];

/* ===== CSVユーティリティ ===== */
const withBust = u => u + (u.includes('?') ? '&' : '?') + 'v=' + Date.now();
function parseCSV(t){
  const r=[]; const L=t.replace(/\r/g,'').split('\n').filter(x=>x.trim());
  for(const line of L){
    const row=[]; let s='',q=false;
    for(let i=0;i<line.length;i++){
      const c=line[i];
      if(c==='"'){ if(q && line[i+1]==='"'){ s+='"'; i++; } else q=!q; }
      else if(c===',' && !q){ row.push(s); s=''; }
      else s+=c;
    }
    row.push(s); r.push(row);
  }
  return r;
}
async function fetchCSV(u){
  const res = await fetch(withBust(u), {cache:'no-store'});
  if(!res.ok) throw new Error('CSV fetch failed: '+u);
  return parseCSV(await res.text());
}

/* ===== チームCSV → 選手→チーム ===== */
function playerToTeamMap(teamRows){
  const H=teamRows[0]||[];
  const idx={team:-1, p:[-1,-1,-1,-1]};
  H.forEach((v,i)=>{
    const s=String(v||'').replace(/\s/g,'');
    if(s==='チーム名') idx.team=i;
    if(/^選手[①1]$/.test(s)) idx.p[0]=i;
    if(/^選手[②2]$/.test(s)) idx.p[1]=i;
    if(/^選手[③3]$/.test(s)) idx.p[2]=i;
    if(/^選手[④4]$/.test(s)) idx.p[3]=i;
  });
  const map=new Map();
  teamRows.slice(1).forEach(r=>{
    const team=r[idx.team]; if(!team) return;
    idx.p.forEach(pi=>{
      const name = (pi>=0)? r[pi] : '';
      if(name) map.set(String(name).trim(), team);
    });
  });
  return map;
}

/* ===== スコアCSV → 試合ごと集計 ===== */
function aggregateByGame(scoreRows, p2t){
  const H=scoreRows[0]||[];
  let cGame=-1,cName=-1,cPt=-1;
  H.forEach((v,i)=>{
    const s=String(v||'').replace(/\s/g,'');
    if(/^試合$|^試合番号$|^game$/i.test(s)) cGame=i;
    if(/^選手名$|^選手$|^name$/i.test(s))  cName=i;
    if(/^得点$|^pt$|ポイント|score$/i.test(s)) cPt=i;
  });

  const perGameTeam = new Map(); // Map<number, Map<string, number>>
  let latest = 0;

  scoreRows.slice(1).forEach(r=>{
    const g  = Number(String(r[cGame]||'').replace(/[^\d]/g,''))||0;
    const nm = String(r[cName]||'').trim();
    const pt = Number(String(r[cPt]||'').replace(/[^\-\d.]/g,''));
    if(!g || !nm || !isFinite(pt)) return;
    const team = p2t.get(nm);
    if(!team) return;
    if(!perGameTeam.has(g)) perGameTeam.set(g,new Map());
    const m = perGameTeam.get(g);
    m.set(team, (m.get(team)||0) + pt);
    if(g>latest) latest=g;
  });

  const teamSet = new Set();
  for(const m of perGameTeam.values()) for(const t of m.keys()) teamSet.add(t);
  const teams = Array.from(teamSet);

  const seriesDelta = new Map(teams.map(t=>[t, Array(latest).fill(0)]));
  const seriesAcc   = new Map(teams.map(t=>[t, Array(latest).fill(0)]));

  const run = Object.fromEntries(teams.map(t=>[t,0]));
  for(let g=1; g<=latest; g++){
    const m = perGameTeam.get(g) || new Map();
    teams.forEach(t=>{
      const add = m.get(t) || 0;
      run[t] += add;
      seriesDelta.get(t)[g-1] = add;
      seriesAcc.get(t)[g-1]   = run[t];
    });
  }
  return { teams, latestGame: latest, seriesDelta, seriesAcc };
}

/* ===== Chart.js 描画 ===== */
let chart;
function drawChart({teams, latestGame, series, mode}){
  const labels = Array.from({length: Math.max(latestGame,1)}, (_,i)=> i+1);
  const ctx = document.getElementById('chart').getContext('2d');

  const datasets = teams.map((t,i)=>({
    label: t,
    data: (series.get(t)||[]).map((y,x)=>({x:x+1,y})),
    borderColor: colorOf(t,i),
    backgroundColor: colorOf(t,i),
    tension: 0.25,
    pointRadius: 1.6,
    pointHitRadius: 8,
    borderWidth: 2,
    spanGaps: true
  }));

  if(chart) chart.destroy();
  chart = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets },
    options: {
      responsive: true, maintainAspectRatio: false,
      interaction: { mode:'nearest', intersect:false },
      plugins: {
        legend: { position:'top', labels:{ boxWidth:14, usePointStyle:true } },
        tooltip: {
          callbacks: {
            title: (items)=> `試合 ${items[0].parsed.x}`,
            label: (item)=> `${item.dataset.label}: ${item.parsed.y.toFixed(1)}`
          }
        }
      },
      scales: {
        x: { title: { display:true, text:'試合' }, ticks:{ autoSkip:true, maxTicksLimit:10 }, suggestedMin:1, max: latestGame },
        y: { title: { display:true, text: (mode==='acc'?'ポイント（累計）':'ポイント（各試合）') },
             grid: { color:'rgba(255,255,255,.08)' } }
      }
    }
  });

  // 上部チップ
  const bar = document.getElementById('legendChips');
  bar.innerHTML = '';
  teams.forEach((t,i)=>{
    const chip = document.createElement('button');
    chip.className = 'chip';
    chip.style.borderColor = colorOf(t,i);
    chip.style.color = '#fff';
    chip.style.background = 'transparent';
    chip.textContent = t;
    chip.onclick = () => {
      const ds = chart.data.datasets[i];
      ds.hidden = !ds.hidden;
      chart.update();
      chip.style.opacity = ds.hidden ? 0.4 : 1;
    };
    bar.appendChild(chip);
  });
}

/* ===== ロード＆更新 ===== */
async function bootstrap(){
  try{
    const [teamRows, scoreRows] = await Promise.all([
      fetchCSV(TEAM_CSV_URL),
      fetchCSV(SCORE_CSV_URL)
    ]);
    const p2t = playerToTeamMap(teamRows);
    const agg = aggregateByGame(scoreRows, p2t);

    const mode = document.getElementById('mode').value; // 'acc' | 'delta'
    const series = (mode==='acc') ? agg.seriesAcc : agg.seriesDelta;

    drawChart({teams: agg.teams, latestGame: agg.latestGame, series, mode});
    document.getElementById('updated').textContent = new Date().toLocaleString();
  }catch(e){
    console.error(e);
    alert('読み込みに失敗しました。CSV公開URLとヘッダー名を確認してください。');
  }
}

window.addEventListener('load', bootstrap);
document.getElementById('reload').addEventListener('click', bootstrap);
document.getElementById('mode').addEventListener('change', bootstrap);
</script>
</body>
</html>
