<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>勝手にMリーグ｜節ごとのポイント推移</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<style>
  :root{--bg:#0f0f12;--panel:#17171b;--ink:#f6f7fb;--muted:#9aa0a6;--card:#1b1c20;--border:#2a2f37;--accent:#3ea6ff}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font-family:-apple-system,"Noto Sans JP","Hiragino Sans",Roboto,Arial}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--border);background:#121419}
  h1{font-size:16px;margin:0} .sub{color:var(--muted);font-size:12px}
  .wrap{max-width:1080px;margin:0 auto;padding:12px}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  select,button{background:#11151b;border:1px solid var(--border);color:var(--ink);border-radius:8px;padding:8px 10px}
  .pill{border:1px solid var(--border);color:var(--muted);padding:4px 8px;border-radius:999px;font-size:12px}
  .btn{cursor:pointer} .muted{color:var(--muted)}
  canvas{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:6px}
</style>
</head>
<body>
<header>
  <div>
    <h1>勝手にMリーグ｜節ごとのポイント推移</h1>
    <div class="sub">「第1→第3試合」を1セット=1節として集計（累計/節別 切り替え可）</div>
  </div>
  <a href="./" class="pill" style="text-decoration:none">ダッシュボードへ</a>
</header>

<div class="wrap">
  <div class="panel" style="margin-bottom:12px">
    <div class="row" style="margin-bottom:8px">
      <label>表示チーム：</label>
      <select id="teamSelect" multiple size="4" style="min-width:220px"></select>
      <label>表示モード：</label>
      <select id="mode">
        <option value="cum">累計（節ごとに積み上げ）</option>
        <option value="per">節別（その節の増減のみ）</option>
      </select>
      <button id="reload" class="btn">更新</button>
      <span id="updated" class="muted"></span>
    </div>
  </div>

  <canvas id="chart" height="420"></canvas>
</div>

<script>
/* ===== あなたのCSV公開URLに差し替え（/pub?...&output=csv 形式） ===== */
const TEAM_CSV_URL  = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSKiDBUEB6mAd_Jv4YGkDUiZF4PN65NeFnD2lm_sBhbkmWYTk1dvRT0NoAGGxsNTHueHmgQ8iM5up0R/pub?gid=13413896&single=true&output=csv';
const SCORE_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSKiDBUEB6mAd_Jv4YGkDUiZF4PN65NeFnD2lm_sBhbkmWYTk1dvRT0NoAGGxsNTHueHmgQ8iM5up0R/pub?gid=671232666&single=true&output=csv';


/* ===== 以降はそのまま ===== */

// ざっくり色（必要なら後で増やしてOK）
const COLORS = ['#2a7cff','#36b24a','#e0b300','#ff8a3d','#ff5db1','#9b7cff','#19c8c4','#f45d48','#c0ca33','#ab47bc'];

const withBust = u => u + (u.includes('?')?'&':'?') + 'v=' + Date.now();

async function fetchCSV(url){
  const res = await fetch(withBust(url), {cache:'no-store'});
  if(!res.ok) throw new Error('CSV fetch failed: '+url);
  const text = await res.text();
  return parseCSV(text);
}

function parseCSV(t){
  const rows=[]; const L=t.replace(/\r/g,'').split('\n').filter(x=>x.trim().length);
  for(const line of L){
    const out=[]; let cur='', q=false;
    for(let i=0;i<line.length;i++){
      const ch=line[i];
      if(ch=='"'){ if(q && line[i+1]=='"'){ cur+='"'; i++; } else q=!q; }
      else if(ch==',' && !q){ out.push(cur); cur=''; }
      else { cur+=ch; }
    }
    out.push(cur); rows.push(out);
  }
  return rows;
}

function headerIndexMapTeam(hdr){
  const m={};
  hdr.forEach((v,i)=>{
    const s=String(v||'').replace(/\s/g,'');
    if(/^チーム名$/i.test(s)) m.team=i;
    if(/^監督|監督（友人名）$/i.test(s)) m.mgr=i;
    if(/^選手[①1]$/i.test(s)) m.p1=i;
    if(/^選手[②2]$/i.test(s)) m.p2=i;
    if(/^選手[③3]$/i.test(s)) m.p3=i;
    if(/^選手[④4]$/i.test(s)) m.p4=i;
  });
  return m;
}

function headerIndexMapScore(hdr){
  const m={};
  hdr.forEach((v,i)=>{
    const s=String(v||'').replace(/\s/g,'');
    if(/^日付$/i.test(s))       m.date=i;
    if(/^試合番号$/i.test(s))   m.game=i;
    if(/^選手名$/i.test(s))     m.name=i;
    if(/^得点$/i.test(s))       m.pt=i;
  });
  return m;
}

function normalizeName(s){
  return String(s||'').replace(/\s+/g,'').replace(/[★☆◎○▲△▼▽・（）()［］\[\]／\/]/g,'').trim();
}

function toNum(x){
  const n=parseFloat(String(x||'').replace(/[^\d.\-]/g,''));
  return isFinite(n)?n:0;
}

async function loadData(){
  const [teamRows, scoreRows] = await Promise.all([fetchCSV(TEAM_CSV_URL), fetchCSV(SCORE_CSV_URL)]);
  // --- roster: player -> team ---
  const th=headerIndexMapTeam(teamRows[0]||[]), roster=new Map(), teams=[];
  teamRows.slice(1).forEach(r=>{
    const name=r[th.team]; if(!name) return;
    teams.push(name);
    [th.p1,th.p2,th.p3,th.p4].forEach(c=>{
      const p=r[c]; if(p) roster.set(normalizeName(p), name);
    });
  });

  // --- score grouped by date+set ---
  const sh=headerIndexMapScore(scoreRows[0]||[]);
  const sets=[]; // label list
  const idxMap=new Map(); // label -> index
  const agg={}; // team -> [perSet...]

  scoreRows.slice(1).forEach(r=>{
    const date=r[sh.date];
    const game = Math.max(1, parseInt(String(r[sh.game]||'').replace(/[^\d]/g,''))||1);
    const setNo = Math.ceil(game/3);
    const label = `${date} 第${setNo}節`;
    if(!idxMap.has(label)){ idxMap.set(label, sets.length); sets.push(label); }
    const player = normalizeName(r[sh.name]);
    const team = roster.get(player);
    if(!team) return; // ロスター外は無視
    const pt = toNum(r[sh.pt]);

    if(!agg[team]) agg[team]=new Array(sets.length).fill(0);
    // 足りない分を0で埋める
    while(agg[team].length < sets.length) agg[team].push(0);
    const i = idxMap.get(label);
    agg[team][i] += pt;
  });

  return {teams, sets, agg};
}

function toCumulative(arr){
  let s=0; return arr.map(v=> (s+=v));
}

let chart;
function render({teams,sets,agg}, selTeams, mode='cum'){
  const ctx=document.getElementById('chart').getContext('2d');
  if(chart){ chart.destroy(); }

  const datasets = selTeams.map((t,idx)=>{
    const per = (agg[t]||new Array(sets.length).fill(0)).slice(0, sets.length);
    const data = (mode==='cum') ? toCumulative(per) : per;
    return {
      label: t,
      data,
      borderColor: COLORS[idx%COLORS.length],
      backgroundColor: COLORS[idx%COLORS.length],
      tension: 0.2,
      pointRadius: 3
    };
  });

  chart = new Chart(ctx, {
    type: 'line',
    data: { labels: sets, datasets },
    options: {
      responsive: true,
      interaction: { mode:'nearest', intersect:false },
      plugins: { legend:{ position:'bottom' } },
      scales: {
        x: { ticks:{ color:'#cfd2d6' }, grid:{ color:'rgba(255,255,255,0.06)'} },
        y: { ticks:{ color:'#cfd2d6' }, grid:{ color:'rgba(255,255,255,0.06)'} }
      }
    }
  });
}

async function bootstrap(){
  try{
    const data = await loadData();
    // チーム選択肢
    const sel = document.getElementById('teamSelect');
    sel.innerHTML='';
    data.teams.forEach((t,i)=>{
      const opt=document.createElement('option'); opt.value=t; opt.textContent=t;
      if(i<4) opt.selected = true; // 初期で上から少し選択
      sel.appendChild(opt);
    });
    render(data, getSelectedTeams(), document.getElementById('mode').value);
    document.getElementById('reload').onclick = ()=>{
      render(data, getSelectedTeams(), document.getElementById('mode').value);
      document.getElementById('updated').textContent = '更新: ' + new Date().toLocaleString();
    };
    document.getElementById('updated').textContent = '更新: ' + new Date().toLocaleString();
  }catch(e){
    console.error(e);
    alert('読み込みに失敗しました。CSV公開URLとヘッダー名を確認してください。');
  }
}

function getSelectedTeams(){
  return Array.from(document.getElementById('teamSelect').selectedOptions).map(o=>o.value);
}

bootstrap();
</script>
</body>
</html>
