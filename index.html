<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>å‹æ‰‹ã«Mãƒªãƒ¼ã‚°ï½œãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆè‡ªå‹•æ›´æ–°ç‰ˆï¼‰</title>
  <style>
    :root{--bg:#0f0f12;--panel:#17171b;--ink:#fafafa;--muted:#a8a8b3;--green:#1fbf64;--red:#ff5c5c;--card:#1c1c21;--border:#2a2a31}
    *{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--ink);font-family:-apple-system,"Noto Sans JP","Hiragino Sans",Roboto,Arial}
    header{position:sticky;top:0;background:#121216;padding:12px 16px;border-bottom:1px solid var(--border);display:flex;gap:8px;align-items:center;z-index:1}
    h1{font-size:16px;margin:0}.sub{font-size:12px;color:var(--muted)}
    .wrap{padding:12px;max-width:980px;margin:0 auto}
    .leader{background:var(--panel);border:1px solid var(--border);border-radius:12px;margin-bottom:12px}
    .leader .head{display:flex;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--border)}
    table{width:100%;border-collapse:collapse}th,td{padding:8px 10px;border-bottom:1px solid var(--border);font-size:13px;text-align:left}th{color:var(--muted);font-weight:600}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 12px}.tab{padding:8px 12px;border:1px solid var(--border);border-radius:999px;background:transparent;color:var(--ink);font-size:13px}.tab.active{background:var(--panel)}
    .grid{display:grid;grid-template-columns:1fr;gap:10px}@media(min-width:780px){.grid{grid-template-columns:1fr 1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}.card h3{margin:0 0 8px 0;font-size:15px}
    .row{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-top:1px dashed var(--border)}.row:first-of-type{border-top:none}
    .score{font-variant-numeric:tabular-nums}.pos{color:var(--green)}.neg{color:var(--red)}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--border);font-size:12px;color:var(--muted)}
    .teamchip{display:inline-block;padding:2px 8px;border-radius:8px;margin-right:6px;font-size:12px;border:1px solid var(--border)}
    .foot{margin-top:8px;color:var(--muted);font-size:12px}
    .btn{padding:8px 10px;border:1px solid var(--border);background:transparent;color:var(--ink);border-radius:8px}
  </style>
</head>
<body>
<header>
  <div><h1>å‹æ‰‹ã«Mãƒªãƒ¼ã‚° ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1><div class="sub">ã‚¹ãƒãƒ›æœ€é©ãƒ»CSVè‡ªå‹•é€£å‹•ï¼ˆè‡ªå‹•æ›´æ–°ONï¼‰</div></div>
  <div style="margin-left:auto;display:flex;gap:8px;"><button id="reloadBtn" class="btn">ä»Šã™ãæ›´æ–°</button></div>
</header>

<div class="wrap">
  <div class="leader">
    <div class="head"><div>ğŸ“Š ãƒãƒ¼ãƒ é †ä½</div><div class="pill" id="updatedAt">èª­ã¿è¾¼ã¿ä¸­â€¦</div></div>
    <div style="overflow:auto">
      <table id="rankTbl"><thead><tr><th>é †ä½</th><th>ãƒãƒ¼ãƒ </th><th>åˆè¨ˆ</th></tr></thead><tbody></tbody></table>
    </div>
  </div>
  <div class="tabs" id="teamTabs"></div>

  <a href="results.html" class="btn">è©¦åˆçµæœãƒšãƒ¼ã‚¸</a>

  
  <div class="grid" id="cards"></div>
  <div class="foot">ãƒ‡ãƒ¼ã‚¿å…ƒï¼šãƒãƒ¼ãƒ ç·¨æˆ CSV / ã‚¹ã‚³ã‚¢å…¥åŠ› CSVï¼ˆå¤œé–“è‡ªå‹•ãƒªãƒ­ãƒ¼ãƒ‰: 23:50 / 10åˆ†ã”ã¨ï¼‰</div>
</div>

<script>
/* ====== è¨­å®šï¼ˆã‚ãªãŸã®CSVå…¬é–‹URLï¼‰ ====== */
const TEAM_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSKiDBUEB6mAd_Jv4YGkDUiZF4PN65NeFnD2lm_sBhbkmWYTk1dvRT0NoAGGxsNTHueHmgQ8iM5up0R/pub?gid=13413896&single=true&output=csv';
const SCORE_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSKiDBUEB6mAd_Jv4YGkDUiZF4PN65NeFnD2lm_sBhbkmWYTk1dvRT0NoAGGxsNTHueHmgQ8iM5up0R/pub?gid=671232666&single=true&output=csv';

/* ãƒãƒ¼ãƒ è‰²ï¼ˆä»»æ„ï¼‰ */
const TEAM_COLORS={
  "å¤§è¼”ãƒãƒ¼ãƒ ":"#2a7cff","ã—ã’ãƒãƒ¼ãƒ ":"#36b24a","ã¾ããƒãƒ¼ãƒ ":"#e0b300",
  "ã‚‚ã‚Šãƒãƒ¼ãƒ ":"#ff8a3d","ãƒã‚µã‚­ãƒ³ã‚°ãƒãƒ¼ãƒ ":"#ff5db1","ã‚±ãƒ¼ã‚¿ãƒãƒ¼ãƒ ":"#ff0000"
};

/* è¡¨ç¤ºãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ */
const fmt = n => (n>0?'+':'')+(Math.round(n*10)/10).toFixed(1);
const cls = n => n>=0 ? 'pos' : 'neg';

/* ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¹ã‚¿ãƒ¼ */
const withBust = u => u + (u.includes('?') ? '&' : '?') + 'v=' + Date.now();

/* CSV ãƒ‘ãƒ¼ã‚¹ */
function parseCSV(t){
  const r=[]; const L=t.replace(/\r/g,'').split('\n').filter(x=>x.trim().length);
  for(let l of L){
    const o=[]; let c='',q=false;
    for(let i=0;i<l.length;i++){
      const ch=l[i];
      if(ch=='"'){ if(q&&l[i+1]=='"'){c+='"';i++;} else q=!q; }
      else if(ch===','&&!q){ o.push(c); c=''; }
      else c+=ch;
    }
    o.push(c); r.push(o);
  }
  return r;
}
async function fetchCSV(u){
  const res = await fetch(withBust(u), {cache:'no-store'});
  if(!res.ok) throw new Error('CSV fetch failed: '+u);
  return parseCSV(await res.text());
}

/* ãƒ˜ãƒƒãƒ€ãƒ¼è§£æ */
function headerIndexMap(h){
  const i={};
  h.forEach((v,k)=>{
    const s=(v||'').replace(/\s/g,'');
    if(/^(ãƒãƒ¼ãƒ å)$/i.test(s)) i.team=k;
    if(/^(ç›£ç£|ç›£ç£ï¼ˆå‹äººåï¼‰)$/i.test(s)) i.mgr=k;
    if(/^é¸æ‰‹[â‘ 1]$/i.test(s)) i.p1=k;
    if(/^é¸æ‰‹[â‘¡2]$/i.test(s)) i.p2=k;
    if(/^é¸æ‰‹[â‘¢3]$/i.test(s)) i.p3=k;
    if(/^é¸æ‰‹[â‘£4]$/i.test(s)) i.p4=k;
  });
  return i;
}

/* ã‚¹ã‚³ã‚¢å…¥åŠ›CSV â†’ é¸æ‰‹åˆ¥åˆè¨ˆ */
function groupScoreByPlayer(scoreRows){
  const m=new Map();
  const H=scoreRows[0]||[];
  let colName=-1, colPt=-1;
  H.forEach((v,k)=>{
    const s=(v||'').replace(/\s/g,'');
    if(/^(é¸æ‰‹å)$/i.test(s)) colName=k;
    if(/^(å¾—ç‚¹)$/i.test(s))   colPt=k;
  });
  scoreRows.slice(1).forEach(r=>{
    const name=r[colName];
    const pt=parseFloat((r[colPt]||'').replace(/[^\d.+\-]/g,''));
    if(!name||isNaN(pt))return;
    m.set(name,(m.get(name)||0)+pt);
  });
  return m;
}

/* ãƒãƒ¼ãƒ æ§‹ç¯‰ï¼ˆã‚¹ã‚³ã‚¢å…¥åŠ›å„ªå…ˆç‰ˆï¼‰ */
function buildTeams(teamRows,scoreMap){
  const hdr=teamRows[0]||[];
  const id=headerIndexMap(hdr);
  const rows=teamRows.slice(1).filter(r=>(r[id.team]||'').trim().length);
  return rows.map(r=>{
    const val=k=>typeof k==='number'?r[k]:'';
    const players=[];
    const p=[id.p1,id.p2,id.p3,id.p4];

    for(let k=0;k<4;k++){
      const name=val(p[k]);
      if(!name) continue;
      const sc=(scoreMap && scoreMap.has(name)) ? scoreMap.get(name) : 0;
      players.push({name,score:sc});
    }

    const total=players.reduce((a,b)=>a+b.score,0);
    return {name:val(id.team),manager:val(id.mgr),players,total};
  });
}

/* æç”» */
function renderRank(ts){
  const tb=document.querySelector('#rankTbl tbody'); tb.innerHTML='';
  [...ts].sort((a,b)=>b.total-a.total).forEach((t,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td>
      <td><span class="teamchip" style="background:${TEAM_COLORS[t.name]||'transparent'}22;border-color:${TEAM_COLORS[t.name]||'var(--border)'}">${t.name}</span></td>
      <td class="score ${cls(t.total)}">${fmt(t.total)}</td>`;
    tb.appendChild(tr);
  });
}
function renderTabs(ts){
  const tabs=document.getElementById('teamTabs'); tabs.innerHTML='';
  const all=document.createElement('button'); all.className='tab active'; all.textContent='å…¨ãƒãƒ¼ãƒ ';
  all.onclick=()=>{document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));all.classList.add('active');renderCards(ts);};
  tabs.appendChild(all);
  ts.forEach(t=>{
    const b=document.createElement('button'); b.className='tab'; b.textContent=t.name;
    b.onclick=()=>{document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));b.classList.add('active');renderCards([t]);};
    tabs.appendChild(b);
  });
}
function renderCards(ts){
  const w=document.getElementById('cards'); w.innerHTML='';
  ts.forEach(t=>{
    const card=document.createElement('div'); card.className='card';
    card.innerHTML=`<h3>â–  <span>${t.name}</span> <span class="pill">ç›£ç£: ${t.manager||''}</span></h3>`
      + t.players.map(p=>`<div class="row"><div>${p.name}</div><div class="score ${cls(p.score)}">${fmt(p.score)}</div></div>`).join('')
      + `<div class="row"><div><strong>åˆè¨ˆ</strong></div><div class="score ${cls(t.total)}"><strong>${fmt(t.total)}</strong></div></div>`;
    w.appendChild(card);
  });
}

/* èµ·å‹• */
async function bootstrap(){
  try{
    const [teamRows,scoreRows] = await Promise.all([
      fetchCSV(TEAM_CSV_URL),
      fetchCSV(SCORE_CSV_URL).catch(()=>[[]])
    ]);
    const scoreMap=(scoreRows&&scoreRows.length>1)?groupScoreByPlayer(scoreRows):null;
    const teams=buildTeams(teamRows,scoreMap);
    renderRank(teams); renderTabs(teams); renderCards(teams);
    document.getElementById('updatedAt').textContent=new Date().toLocaleString();
  }catch(e){
    console.error(e);
    document.getElementById('updatedAt').textContent='èª­ã¿è¾¼ã¿å¤±æ•—';
  }
}
document.getElementById('reloadBtn').addEventListener('click',bootstrap);
bootstrap();

/* 10åˆ†ã”ã¨å†å–å¾— & 23:50ã«ãƒšãƒ¼ã‚¸è‡ªä½“ã‚’å†èª­è¾¼ */
setInterval(bootstrap,10*60*1000);
setInterval(()=>{const d=new Date();if(d.getHours()===23&&d.getMinutes()===50) location.reload();},30*1000);
</script>
</body>
</html>
